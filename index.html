<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Mortgage Payoff, NPV & Equity Growth Calculator</title>
    
    <!-- Load Tailwind CSS CDN - FIXED to use the official, unversioned link for reliability -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for dynamic visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <!-- Custom configuration for Tailwind colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#1C768F', // Deep Teal-Blue (Debt Focus)
                        'accent': '#1e8749',  // Green (Equity Focus)
                        'npv': '#E86F00', // Orange (NPV/Opportunity Cost)
                        'dti-safe': '#10b981', // Emerald 500
                        'dti-high': '#f59e0b', // Amber 500
                        'dti-critical': '#ef4444', // Red 500
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

    <style>
        /* Essential structure styles that are hard to do with pure utility classes */
        #chartContainer {
            position: relative; 
            height: 400px; /* Increased height for better visualization */
            width: 100%;
        }
        
        /* Ensure table cells don't wrap for a clean scrolling experience */
        #amortizationTable th, #amortizationTable td {
            white-space: nowrap; 
        }
        
        /* CRITICAL: Apply 30% / 70% split on large screens (lg breakpoint) */
        @media (min-width: 1024px) {
            .main-grid-layout {
                grid-template-columns: 30% 70%; 
            }
        }
        
    </style>
</head>
<body class="bg-gray-100 font-sans p-2 md:p-6 flex justify-center text-gray-800 text-sm">

    <div class="calculator-container bg-white p-4 md:p-8 rounded-xl shadow-2xl w-full max-w-6xl">
        
        <!-- Header Section -->
        <div class="bg-sky-50 p-4 rounded-lg mb-4 shadow-sm">
            <h1 class="text-xl md:text-2xl font-extrabold text-primary text-center">
                Ultimate Mortgage Payoff, NPV, DTI & Equity Growth Calculator
            </h1>
        </div>
        
        <!-- NEW MAIN GRID LAYOUT FOR TWO COLUMNS -->
        <div class="main-grid-layout grid grid-cols-1 gap-6 mt-4 lg:grid-cols-2">
            
            <!-- === LEFT COLUMN: ALL INPUTS (30% width on large screens) === -->
            <div class="input-column flex flex-col gap-4">
                
                <!-- 1. Loan Core Details (Set to OPEN) -->
                <details open class="bg-white rounded-lg shadow-lg border border-gray-200">
                    <summary class="p-4 font-bold text-base text-primary border-b border-gray-200 cursor-pointer flex justify-between items-center list-none relative before:content-['+'] open:before:content-['−'] before:absolute before:right-4 before:text-xl">
                        Loan Core Details
                    </summary>
                    <div class="input-section grid grid-cols-1 sm:grid-cols-2 gap-4 p-4">
                        <div class="space-y-1">
                            <label for="loanAmount" class="block font-medium text-sm text-gray-700">Loan Principal ($/£/€):</label>
                            <input type="number" id="loanAmount" value="300000" min="1000" step="1000" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                        </div>
                        
                        <div class="space-y-1">
                            <label for="initialLTV" class="block font-medium text-sm text-gray-700">Initial LTV (%):</label>
                            <input type="number" id="initialLTV" value="90" min="5" max="100" step="1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                        </div>
            
                        <div class="space-y-1">
                            <label for="interestRate" class="block font-medium text-sm text-gray-700">Annual P&I Rate (%):</label>
                            <input type="number" id="interestRate" value="6.5" min="0.1" max="25" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                        </div>
            
                        <div class="space-y-1">
                            <label for="loanTerm" class="block font-medium text-sm text-gray-700">Original Term (Years):</label>
                            <input type="number" id="loanTerm" value="30" min="5" max="50" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                        </div>
                        
                        <div class="space-y-1 col-span-1 sm:col-span-2">
                            <label for="repaymentFrequency" class="block font-medium text-sm text-gray-700">Frequency (Periods/yr):</label>
                            <select id="repaymentFrequency" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary h-[42px]">
                                <option value="12">Monthly (12)</option>
                                <option value="26">Bi-Weekly (26)</option>
                                <option value="24">Semi-Monthly (24)</option>
                                <option value="52">Weekly (52)</option>
                            </select>
                        </div>
                    </div>
                </details>

                <!-- 2. DTI ANALYSIS INPUTS -->
                <details open class="bg-white rounded-lg shadow-lg border border-gray-200">
                    <summary class="p-4 font-bold text-base text-dti-safe border-b border-gray-200 cursor-pointer flex justify-between items-center list-none relative before:content-['+'] open:before:content-['−'] before:absolute before:right-4 before:text-xl">
                        Debt-to-Income (DTI) Inputs
                    </summary>
                    <div class="input-section grid grid-cols-1 sm:grid-cols-2 gap-4 p-4">
                        <div class="space-y-1">
                            <label for="annualIncome" class="block font-medium text-sm text-gray-700">Annual Gross Income ($):</label>
                            <input type="number" id="annualIncome" value="120000" min="0" step="1000" class="w-full p-2 border border-gray-300 rounded-md focus:ring-dti-safe focus:border-dti-safe">
                        </div>
                        <div class="space-y-1">
                            <label for="nonMortgageDebt" class="block font-medium text-sm text-gray-700">Total Monthly Non-Mortgage Debt ($):</label>
                            <input type="number" id="nonMortgageDebt" value="800" min="0" step="50" class="w-full p-2 border border-gray-300 rounded-md focus:ring-dti-safe focus:border-dti-safe">
                            <p class="text-xs text-gray-600 mt-1">Includes car, student, and credit card payments.</p>
                        </div>
                    </div>
                </details>


                <!-- 3. PITI and Advanced Payoff Details (Updated for Appreciation) -->
                <details open class="bg-white rounded-lg shadow-lg border border-gray-200">
                    <summary class="p-4 font-bold text-base text-primary border-b border-gray-200 cursor-pointer flex justify-between items-center list-none relative before:content-['+'] open:before:content-['−'] before:absolute before:right-4 before:text-xl">
                        PITI, PMI, Payoff & Economic Inputs
                    </summary>
                    <div class="input-section grid grid-cols-1 sm:grid-cols-2 gap-4 p-4">
                        
                        <!-- NEW: Appreciation Rate -->
                         <div class="space-y-1 col-span-1 sm:col-span-2 bg-accent/10 p-2 rounded-md border border-accent/30">
                            <label for="appreciationRate" class="block font-bold text-sm text-accent">Annual Property Appreciation Rate (%):</label>
                            <input type="number" id="appreciationRate" value="3.5" min="0" max="15" step="0.1" class="w-full p-2 border border-accent/50 rounded-md focus:ring-accent focus:border-accent">
                            <p class="text-xs text-gray-600 mt-1">Used to project future home value and equity.</p>
                        </div>

                        <!-- Discount Rate -->
                         <div class="space-y-1 col-span-1 sm:col-span-2 bg-npv/10 p-2 rounded-md border border-npv/30">
                            <label for="discountRate" class="block font-bold text-sm text-npv">Annual Investment/Inflation Rate (Discount Rate) %:</label>
                            <input type="number" id="discountRate" value="3.0" min="0" max="20" step="0.1" class="w-full p-2 border border-npv/50 rounded-md focus:ring-npv focus:border-npv">
                            <p class="text-xs text-gray-600 mt-1">Used for Net Present Value (NPV) calculation.</p>
                        </div>
                        
                        <!-- PITI Escalation -->
                        <div class="space-y-1">
                            <label for="pitiEscalationRate" class="block font-medium text-sm text-red-700">Annual PITI Escalation Rate (%):</label>
                            <input type="number" id="pitiEscalationRate" value="2.0" min="0" max="10" step="0.1" class="w-full p-2 border border-red-300 rounded-md focus:ring-red-500 focus:border-red-500">
                        </div>
                        <!-- PMI -->
                        <div class="space-y-1">
                            <label for="pmiRate" class="block font-medium text-sm text-gray-700">Annual PMI Rate (e.g., 0.5%):</label>
                            <input type="number" id="pmiRate" value="0.5" min="0" max="5" step="0.05" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                        </div>
                        
                        <!-- PITI Components -->
                        <div class="space-y-1">
                            <label for="propertyTax" class="block font-medium text-sm text-gray-700">Annual Property Tax ($):</label>
                            <input type="number" id="propertyTax" value="3600" min="0" step="10" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                        </div>
                        <div class="space-y-1">
                            <label for="insurance" class="block font-medium text-sm text-gray-700">Annual Home Insurance ($):</label>
                            <input type="number" id="insurance" value="1200" min="0" step="10" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                        </div>
                        <div class="space-y-1">
                            <label for="hoa" class="block font-medium text-sm text-gray-700">Monthly HOA Dues ($):</label>
                            <input type="number" id="hoa" value="0" min="0" step="10" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                        </div>
                        
                        <!-- Extra Payments -->
                        <div class="space-y-1">
                            <label for="extraPayment" class="block font-medium text-sm text-gray-700">Extra Principal (Per Period):</label>
                            <input type="number" id="extraPayment" value="100" min="0" step="10" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                        </div>
                        
                        <div class="space-y-1">
                            <label for="lumpSumPayment" class="block font-medium text-sm text-gray-700">One-Time Lump Sum ($):</label>
                            <input type="number" id="lumpSumPayment" value="5000" min="0" step="500" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                        </div>
                        
                        <div class="space-y-1">
                            <label for="lumpSumPeriod" class="block font-medium text-sm text-gray-700">Lump Sum Applied at Period:</label>
                            <input type="number" id="lumpSumPeriod" value="1" min="1" max="360" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                        </div>
                        
                    </div>
                </details>

                <!-- 4. Refinance Scenario (Closed by default) -->
                <details class="bg-white rounded-lg shadow-lg border border-gray-200">
                    <summary class="p-4 font-bold text-base text-primary border-b border-gray-200 cursor-pointer flex justify-between items-center list-none relative before:content-['+'] open:before:content-['−'] before:absolute before:right-4 before:text-xl">
                        Refinance Scenario Modeling
                    </summary>
                    <div class="input-section grid grid-cols-1 sm:grid-cols-2 gap-4 p-4">
                        <div class="space-y-1">
                            <label for="refiPeriod" class="block font-medium text-sm text-gray-700">Refinance at Period:</label>
                            <input type="number" id="refiPeriod" value="60" min="1" max="360" step="12" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                        </div>
                        
                        <div class="space-y-1">
                            <label for="refiClosingCosts" class="block font-medium text-sm text-red-700">Refi Closing Costs ($):</label>
                            <input type="number" id="refiClosingCosts" value="5000" min="0" step="100" class="w-full p-2 border border-red-300 rounded-md focus:ring-red-500 focus:border-red-500">
                        </div>

                        <div class="space-y-1">
                            <label for="refiRate" class="block font-medium text-sm text-gray-700">New Annual Rate (%):</label>
                            <input type="number" id="refiRate" value="5.0" min="0.1" max="20" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                        </div>
                        <div class="space-y-1">
                            <label for="refiTerm" class="block font-medium text-sm text-gray-700">New Term (Remaining Years):</label>
                            <input type="number" id="refiTerm" value="15" min="1" max="30" step="1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                        </div>
                    </div>
                </details>

                <!-- 5. Interest Rate Shock Test (Closed by default) -->
                <details class="bg-white rounded-lg shadow-lg border border-gray-200">
                    <summary class="p-4 font-bold text-base text-primary border-b border-gray-200 cursor-pointer flex justify-between items-center list-none relative before:content-['+'] open:before:content-['−'] before:absolute before:right-4 before:text-xl">
                        Interest Rate Shock Test (Variable Rate Stress)
                    </summary>
                    <div class="input-section p-4">
                        <div class="space-y-1">
                            <label for="shockRateIncrease" class="block font-medium text-sm text-gray-700">Model Future Rate Increase by (%):</label>
                            <div class="flex gap-2 mt-1">
                                <input type="number" id="shockRateIncrease" value="1.0" min="0.1" max="5" step="0.1" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500">
                                <button onclick="calculateMortgage(true)" class="bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg shadow-md transition duration-150 py-2 px-4 w-1/2">
                                    Run Shock Test
                                </button>
                            </div>
                        </div>
                    </div>
                </details>
                
                <!-- PRIMARY CTA BUTTONS - MOVED TO THE BOTTOM OF THE INPUT COLUMN -->
                <div class="flex flex-col sm:flex-row gap-3 md:gap-4 mt-2">
                    <button onclick="calculateMortgage()" class="w-full px-4 py-3 bg-primary text-white font-semibold rounded-lg shadow-xl hover:bg-sky-700 transition duration-150 min-h-11">
                        Calculate Full Scenario
                    </button>
                    <button id="clearButton" onclick="clearForm()" class="w-full px-4 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition duration-150 min-h-11">
                        Clear Form and Results
                    </button>
                </div>
            </div>
            <!-- === END LEFT COLUMN === -->
            
            <!-- === RIGHT COLUMN: ALL OUTPUTS (70% width on large screens) === -->
            <div class="output-column flex flex-col gap-4">

                <div id="results" class="p-4 bg-gray-50 rounded-lg shadow-inner border border-gray-200">
                    <h2 class="text-lg font-bold text-gray-800 mb-2">Calculation Summary</h2>
                    
                    <p class="text-xl py-2 font-bold">Estimated Initial Monthly Payment (PITI + PMI): <span id="totalMonthlyPaymentPITI" class="text-primary"></span></p>
                    
                    <!-- PMI Note -->
                    <p class="text-xs text-red-600 text-center p-2 border-dashed border border-amber-500 bg-amber-50 rounded-md mt-2" id="pmiDropNote" style="display: none;">
                        PMI included until period <span id="pmiDropPeriod" class="font-bold"></span>, when LTV drops to 80%.
                    </p>

                    <!-- DTI Analysis Results -->
                    <div id="dti-results" class="mt-4 p-3 rounded-lg border border-dti-safe/50 bg-white shadow-md">
                        <h3 class="text-base font-bold text-dti-safe mb-2 border-b pb-1">Debt-to-Income (DTI) Analysis</h3>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="p-2 rounded-lg bg-gray-50 border">
                                <p class="text-xs font-medium text-gray-600">Front-End DTI (Housing)</p>
                                <p id="frontEndDTI" class="text-xl font-extrabold text-dti-safe"></p>
                                <p id="frontEndDTIStatus" class="text-xs font-semibold mt-1"></p>
                            </div>
                            <div class="p-2 rounded-lg bg-gray-50 border">
                                <p class="text-xs font-medium text-gray-600">Back-End DTI (Total Debt)</p>
                                <p id="backEndDTI" class="text-xl font-extrabold text-dti-safe"></p>
                                <p id="backEndDTIStatus" class="text-xs font-semibold mt-1"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Equity Summary (NEW) -->
                    <div id="equity-summary" class="mt-4 p-3 rounded-lg border border-accent/50 bg-white shadow-md">
                        <h3 class="text-base font-bold text-accent mb-2 border-b pb-1">Projected Equity Growth</h3>
                        <div class="grid grid-cols-2 gap-4 text-center">
                             <div class="p-2 rounded-lg bg-gray-50 border">
                                <p class="text-xs font-medium text-gray-600">Total Equity at Payoff</p>
                                <p id="finalEquity" class="text-xl font-extrabold text-accent"></p>
                            </div>
                            <div class="p-2 rounded-lg bg-gray-50 border">
                                <p class="text-xs font-medium text-gray-600">Final Property Value</p>
                                <p id="finalPropertyValue" class="text-xl font-extrabold text-accent"></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chart Container -->
                    <div id="chartContainer" class="mt-4 bg-white rounded-lg shadow-md p-2">
                        <canvas id="comparisonChart"></canvas>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm">
                        <!-- Original Loan Box -->
                        <div class="bg-gray-100 p-3 rounded-lg border border-gray-200">
                            <h3 class="text-base font-semibold text-gray-700 mb-1">Original Loan (Standard)</h3>
                            <p>P&I Payment: <span id="standardPaymentDisplay"></span></p>
                            <p>Payoff Date: <span id="originalPayoffDate"></span></p>
                            <p class="mt-2 text-primary font-bold">Total Interest Paid: <span id="totalInterestOriginal"></span></p>
                            <p class="text-npv font-bold">NPV of Interest Cost: <span id="npvOriginal"></span></p>
                        </div>
                        <!-- Accelerated Scenario Box -->
                        <div class="bg-gray-100 p-3 rounded-lg border border-gray-200">
                            <h3 class="text-base font-semibold text-gray-700 mb-1">Accelerated Scenario</h3>
                            <p>Accelerated P&I Payment: <span id="acceleratedPaymentDisplay"></span></p>
                            <p>New Payoff Date: <span id="newPayoffDate" class="text-accent font-bold"></span></p>
                            <p class="mt-2 text-primary font-bold">Total Interest Paid: <span id="totalInterestNew"></span></p>
                            <p class="text-npv font-bold">NPV of Interest Cost: <span id="npvNew"></span></p>
                        </div>
                    </div>
                    
                    <!-- Main Savings Banner -->
                    <p class="text-md mt-4 p-2 bg-accent/10 rounded-lg text-center font-medium">
                        You saved <span class="text-accent font-extrabold" id="interestSaved"></span> in Nominal Interest and shaved off <span class="text-accent font-extrabold" id="timeSaved"></span> from the loan term!
                    </p>
                    
                    <!-- NPV Conclusion Banner -->
                    <p class="text-md mt-2 p-2 bg-npv/10 rounded-lg text-center font-medium border-l-4 border-npv">
                         NPV Savings: <span class="text-npv font-extrabold" id="npvSaved"></span> (The true value saved in today's dollars).
                    </p>
                </div>
                
                <!-- 4. Shock Test Results -->
                <div id="shock-results" class="p-4 bg-red-100 rounded-lg shadow-inner border border-red-300" style="display: none;">
                    <h2 class="text-lg font-bold text-red-700 mb-2">Interest Rate Shock Test Result</h2>
                    <p class="text-lg">New Rate: <span id="shockRateDisplay" class="text-red-600 font-bold"></span>%</p>
                    <p>Original P&I Payment: <span id="originalShockPaymentDisplay"></span></p>
                    <p class="text-lg py-1">New Shock P&I Payment: <span id="shockPaymentDisplay" class="text-red-600 font-bold"></span> (Increase of <span id="paymentIncrease" class="text-red-600 font-bold"></span>)</p>
                </div>

                <!-- 5. Amortization Schedule -->
                <div id="schedule-wrapper" class="bg-white rounded-lg shadow-lg border border-gray-200">
                    <details>
                        <summary class="p-4 font-bold text-base text-primary border-b border-gray-200 cursor-pointer flex justify-between items-center list-none relative before:content-['+'] open:before:content-['−'] before:absolute before:right-4 before:text-xl">
                            View Full Amortization Schedule Comparison (Refi, PMI, Escalation & NPV)
                        </summary>
                        <div id="schedule" class="overflow-x-auto max-w-full p-4">
                            <table id="amortizationTable" class="min-w-[1200px] w-full border-collapse">
                                <!-- Table content generated by JS -->
                            </table>
                            <p class="text-center text-xs text-primary/80 mt-2 italic">
                                ← Scroll for full comparison →
                            </p>
                        </div>
                    </details>
                </div>
                
            </div>
            <!-- === END RIGHT COLUMN === -->
        </div>
        <!-- END MAIN GRID LAYOUT -->
        
    </div>

    <script>
        /* --- JAVASCRIPT LOGIC --- */
        
        let mortgageChart = null; // Global reference for the chart instance

        // Function to format currency to US/Tier 1 standard (e.g., $1,234.56)
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0 // Keep it simple for large values
            }).format(amount);
        };
        
        // Function to format as percentage
        const formatPercent = (amount) => {
             return (amount * 100).toFixed(1) + '%';
        }

        // Core calculation logic for fixed-rate, amortized loans
        function calculatePayment(principal, annualRate, periodsPerYear, totalPeriods) {
            if (annualRate === 0 || totalPeriods === 0) {
                return principal / totalPeriods; 
            }
            const periodicRate = annualRate / periodsPerYear;
            
            if (periodicRate === 0) {
                 return principal / totalPeriods;
            }
            
            const payment = principal * periodicRate / (1 - Math.pow(1 + periodicRate, -totalPeriods));
            return isFinite(payment) ? payment : 0;
        }

        // --- Core Amortization Generator (UPDATED FOR EQUITY) ---
        function generateAmortization(principal, annualRate, periodsPerYear, totalPeriods, extraPaymentPerPeriod, lumpSumAmount, lumpSumPeriod, initialLTV, pmiRate, refiPeriod, refiRate, refiTerm, refiClosingCosts, pitiEscalationRate, discountRate, appreciationRate) {
            
            let currentBalance = principal;
            let currentRate = annualRate;
            let totalPeriodsRemaining = totalPeriods;
            
            const standardPaymentOriginal = calculatePayment(principal, annualRate, periodsPerYear, totalPeriods);
            let standardPayment = standardPaymentOriginal;
            
            let totalInterestPaid = 0;
            let totalPVInterestPaid = 0; 
            let payoffPeriod = 0;
            let pmiDropPeriod = null;

            let amortizationSchedule = [];
            const periodicPmiRate = pmiRate / periodsPerYear;
            const periodicDiscountRate = discountRate / periodsPerYear; 
            const periodicAppreciationRate = appreciationRate / periodsPerYear; // NEW: Periodic Appreciation Rate
            
            // Calculate initial property value for LTV tracking and equity growth
            const initialPropertyValue = (initialLTV > 0 && initialLTV <= 100) ? principal / (initialLTV / 100) : principal;
            let currentPropertyValue = initialPropertyValue; // Track market value
            const pmiStopThreshold = 0.80 * initialPropertyValue;

            let isPMIActive = (initialLTV > 80);
            let hasRefinanced = false;

            // PITI Escalation Variables
            let currentAnnualTax = parseFloat(document.getElementById('propertyTax').value) || 0;
            let currentAnnualInsurance = parseFloat(document.getElementById('insurance').value) || 0;
            let currentMonthlyHoa = parseFloat(document.getElementById('hoa').value) || 0;
            const escalationFactor = 1 + (pitiEscalationRate / 100);

            let maxBalance = 0;


            for (let period = 1; currentBalance > 0 && period <= 50 * periodsPerYear; period++) {
                
                // --- PITI & APPRECIATION LOGIC: Apply increase at the start of each new loan year ---
                if (period > 1) {
                    // PITI Escalation
                    if ((period - 1) % periodsPerYear === 0) {
                        currentAnnualTax *= escalationFactor;
                        currentAnnualInsurance *= escalationFactor;
                        currentMonthlyHoa *= escalationFactor;
                    }
                    
                    // Property Appreciation (applied every period for smooth line)
                    currentPropertyValue *= (1 + periodicAppreciationRate);
                }

                
                let periodicRate = currentRate / periodsPerYear;
                let principalPayment = 0;
                let interest = 0;
                
                // --- REFINANCING LOGIC ---
                if (!hasRefinanced && refiPeriod > 0 && period >= refiPeriod) {
                    if (currentBalance > 0) {
                         currentBalance += refiClosingCosts; 
                    }
                    currentRate = refiRate / 100;
                    totalPeriodsRemaining = Math.max(0, (refiTerm * periodsPerYear));
                    
                    // Recalculate P&I payment 
                    standardPayment = calculatePayment(currentBalance, currentRate, periodsPerYear, totalPeriodsRemaining);
                    hasRefinanced = true;
                }


                // --- AMORTIZATION CORE ---
                interest = currentBalance * periodicRate;
                
                let calculatedPayment = standardPayment;
                if (currentBalance < calculatedPayment) {
                    calculatedPayment = currentBalance + interest;
                } else if (calculatedPayment <= interest) {
                    calculatedPayment = interest + 1; 
                }
                
                principalPayment = calculatedPayment - interest;
                
                let extraPrincipal = extraPaymentPerPeriod;
                
                // Lump Sum Application
                if (lumpSumAmount > 0 && period === lumpSumPeriod) {
                    extraPrincipal += lumpSumAmount;
                }
                
                let totalPrincipalPaid = principalPayment + extraPrincipal;
                
                // Check for final payment
                if (currentBalance < totalPrincipalPaid) {
                    totalPrincipalPaid = currentBalance;
                    principalPayment = totalPrincipalPaid - extraPrincipal; 
                    if (principalPayment < 0) principalPayment = 0;
                }
                
                currentBalance -= totalPrincipalPaid;
                totalInterestPaid += interest;

                // --- NPV LOGIC ---
                const discountFactor = Math.pow(1 + periodicDiscountRate, period);
                const pvInterest = interest / discountFactor;
                totalPVInterestPaid += pvInterest;


                // --- PMI LOGIC ---
                let pmiPayment = 0;
                if (isPMIActive) {
                    pmiPayment = currentBalance * periodicPmiRate;
                    if (currentBalance <= pmiStopThreshold) {
                        isPMIActive = false;
                        pmiDropPeriod = period;
                    }
                }
                
                // Total required periodic payment (P&I + PMI + Escalated PITI)
                const periodicPITI = (currentAnnualTax / periodsPerYear) + (currentAnnualInsurance / periodsPerYear) + currentMonthlyHoa + pmiPayment;
                
                const currentEquity = Math.max(0, currentPropertyValue - currentBalance); // NEW Equity

                amortizationSchedule.push({ 
                    period, 
                    interest: Math.max(0, interest), 
                    principalPaid: Math.max(0, totalPrincipalPaid), 
                    balance: Math.max(0, currentBalance),
                    propertyValue: currentPropertyValue, // NEW
                    totalEquity: currentEquity, // NEW
                    pniPrincipal: Math.max(0, principalPayment),
                    extraPayment: extraPrincipal,
                    pmi: pmiPayment,
                    rate: currentRate * 100,
                    periodicPITI: periodicPITI,
                    pvInterest: pvInterest
                });

                if (currentBalance <= 0) {
                    payoffPeriod = period;
                    break;
                }
            }
            
            // The displayed standard payment should be the original P&I payment
            return { 
                schedule: amortizationSchedule, 
                totalInterest: totalInterestPaid, 
                totalPVInterest: totalPVInterestPaid, 
                payoffPeriod, 
                standardPayment: standardPaymentOriginal,
                firstPeriodPITI: amortizationSchedule.length > 0 ? amortizationSchedule[0].periodicPITI * (12 / periodsPerYear) : standardPaymentOriginal,
                pmiDropPeriod,
                finalPropertyValue: currentPropertyValue, // NEW
                finalEquity: Math.max(0, currentPropertyValue) // At payoff, balance is 0
            };
        }
        
        // --- DTI Logic ---
        function calculateDTI(totalMonthlyPITI) {
            const annualIncome = parseFloat(document.getElementById('annualIncome').value) || 0;
            const monthlyNonMortgageDebt = parseFloat(document.getElementById('nonMortgageDebt').value) || 0;
            
            if (annualIncome === 0) {
                return { frontEnd: 0, backEnd: 0 };
            }

            const grossMonthlyIncome = annualIncome / 12;
            
            const frontEndDTI = totalMonthlyPITI / grossMonthlyIncome;
            const backEndDTI = (totalMonthlyPITI + monthlyNonMortgageDebt) / grossMonthlyIncome;
            
            return { frontEnd: frontEndDTI, backEnd: backEndDTI };
        }
        
        // --- DTI Renderer ---
        function renderDTI(frontEndDTI, backEndDTI) {
            const getStatus = (dti) => {
                const ratio = dti * 100;
                if (ratio <= 36) return { text: 'Excellent (<36%)', color: 'dti-safe' };
                if (ratio <= 43) return { text: 'Acceptable (<43%)', color: 'dti-high' };
                return { text: 'High Risk (>43%)', color: 'dti-critical' };
            };

            const frontStatus = getStatus(frontEndDTI);
            const backStatus = getStatus(backEndDTI);

            // Front-End
            const feElement = document.getElementById('frontEndDTI');
            const feStatusElement = document.getElementById('frontEndDTIStatus');
            feElement.textContent = formatPercent(frontEndDTI);
            feElement.className = `text-xl font-extrabold text-${frontStatus.color}`;
            feStatusElement.textContent = frontStatus.text;
            feStatusElement.className = `text-xs font-semibold mt-1 text-${frontStatus.color}`;

            // Back-End
            const beElement = document.getElementById('backEndDTI');
            const beStatusElement = document.getElementById('backEndDTIStatus');
            beElement.textContent = formatPercent(backEndDTI);
            beElement.className = `text-xl font-extrabold text-${backStatus.color}`;
            beStatusElement.textContent = backStatus.text;
            beStatusElement.className = `text-xs font-semibold mt-1 text-${backStatus.color}`;
        }
        
        // --- Chart Renderer (REVAMPED for Equity) ---
        function renderChart(acceleratedResults) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            
            // Destroy previous chart instance if it exists
            if (mortgageChart) {
                mortgageChart.destroy();
            }
            
            // Filter data to show every 12th period (annual view)
            const annualData = acceleratedResults.schedule.filter((_, index) => (index + 1) % 12 === 0);
            
            // Add the final payoff data point if it's not exactly an annual point
            if (acceleratedResults.payoffPeriod % 12 !== 0 && acceleratedResults.schedule.length > 0) {
                annualData.push(acceleratedResults.schedule[acceleratedResults.schedule.length - 1]);
            }
            
            const labels = annualData.map(d => `Yr ${Math.ceil(d.period / 12)}`);
            const remainingBalance = annualData.map(d => d.balance);
            const propertyValue = annualData.map(d => d.propertyValue);
            const totalEquity = annualData.map(d => d.totalEquity);

            mortgageChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Property Value (Market Growth)',
                            data: propertyValue,
                            borderColor: '#1e8749', // Accent/Equity
                            backgroundColor: '#1e8749',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 3
                        },
                        {
                            label: 'Total Home Equity',
                            data: totalEquity,
                            borderColor: '#34d399', // A lighter green
                            backgroundColor: '#34d399',
                            borderWidth: 2,
                            fill: 'origin', // Fill area under Equity line
                            tension: 0.3,
                            pointRadius: 2,
                            stack: 'combined'
                        },
                        {
                            label: 'Remaining Loan Balance',
                            data: remainingBalance,
                            borderColor: '#1C768F', // Primary/Debt
                            backgroundColor: '#1C768F',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time in Years (Approx.)',
                                font: { family: 'Inter', size: 12 }
                            },
                            grid: { display: false }
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value ($)',
                                font: { family: 'Inter', size: 12 }
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value).replace('.00', '').replace('$', ''); 
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { boxWidth: 12, font: { family: 'Inter' } } },
                        title: {
                            display: true,
                            text: 'Equity Accumulation vs. Debt Payoff over Time',
                            font: { family: 'Inter', size: 14, weight: '600' }
                        },
                        tooltip: {
                             mode: 'index',
                             intersect: false,
                             callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    label += formatCurrency(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }


        // --- Main Calculation Function ---
        function calculateMortgage(isShockTest = false) {
            const principal = parseFloat(document.getElementById('loanAmount').value) || 0;
            const annualRate = parseFloat(document.getElementById('interestRate').value) / 100 || 0;
            const termYears = parseFloat(document.getElementById('loanTerm').value) || 0;
            const periodsPerYear = parseInt(document.getElementById('repaymentFrequency').value);
            const totalPeriods = termYears * periodsPerYear;

            // PITI and Escalation Inputs
            const propertyTax = parseFloat(document.getElementById('propertyTax').value) || 0;
            const insurance = parseFloat(document.getElementById('insurance').value) || 0;
            const hoa = parseFloat(document.getElementById('hoa').value) || 0;
            const pitiEscalationRate = parseFloat(document.getElementById('pitiEscalationRate').value) / 100 || 0;
            
            // Payoff Inputs
            const extraPayment = parseFloat(document.getElementById('extraPayment').value) || 0;
            const lumpSumAmount = parseFloat(document.getElementById('lumpSumPayment').value) || 0;
            const lumpSumPeriod = parseInt(document.getElementById('lumpSumPeriod').value) || 1;
            
            // PMI Inputs
            const initialLTV = parseFloat(document.getElementById('initialLTV').value) || 0;
            const pmiRate = parseFloat(document.getElementById('pmiRate').value) / 100 || 0;
            
            // Refinance Inputs
            const refiPeriod = parseInt(document.getElementById('refiPeriod').value) || 1;
            const refiRate = parseFloat(document.getElementById('refiRate').value) || 0; 
            const refiTerm = parseFloat(document.getElementById('refiTerm').value) || 0;
            const refiClosingCosts = parseFloat(document.getElementById('refiClosingCosts').value) || 0; 
            
            // Economic Inputs
            const discountRate = parseFloat(document.getElementById('discountRate').value) / 100 || 0;
            const appreciationRate = parseFloat(document.getElementById('appreciationRate').value) / 100 || 0; // NEW Appreciation Rate
            
            if (principal === 0 || termYears === 0 || annualRate === 0) {
                // If core inputs are zeroed out, hide the results
                document.getElementById('results').style.opacity = 0; 
                document.getElementById('schedule-wrapper').style.opacity = 0;
                document.getElementById('shock-results').style.display = 'none';
                return;
            }
            
            document.getElementById('results').style.opacity = 1; 
            document.getElementById('schedule-wrapper').style.opacity = 1;
            document.getElementById('shock-results').style.display = 'none';

            // === 1. ORIGINAL Scenario (No extras, no refi, no PMI, NO ESCALATION, NO APPRECIATION for cost comparison) ===
            const originalResults = generateAmortization(principal, annualRate, periodsPerYear, totalPeriods, 0, 0, 0, initialLTV, 0, 0, 0, 0, 0, 0, discountRate, 0); // Note: Appreciation is 0 here
            const standardPayment = originalResults.standardPayment; // P&I payment only

            // === 2. ACCELERATED Scenario (All features active) ===
            const acceleratedResults = generateAmortization(principal, annualRate, periodsPerYear, totalPeriods, extraPayment, lumpSumAmount, lumpSumPeriod, initialLTV, pmiRate, refiPeriod, refiRate, refiTerm, refiClosingCosts, pitiEscalationRate, discountRate, appreciationRate);
            const firstPeriodData = acceleratedResults.schedule[0];
            
            // --- Initial PITI Calculation ---
            const monthlyPNI = standardPayment * (12 / periodsPerYear);
            const initialPMIPeriodic = firstPeriodData ? firstPeriodData.pmi : 0;
            const initialPMIMonthly = initialPMIPeriodic * (12 / periodsPerYear);

            const initialMonthlyTax = propertyTax / 12;
            const initialMonthlyInsurance = insurance / 12;

            const totalMonthlyPITI = monthlyPNI + initialMonthlyTax + initialMonthlyInsurance + hoa + initialPMIMonthly;
            
            // --- DTI Calculation ---
            const dtiResults = calculateDTI(totalMonthlyPITI);
            renderDTI(dtiResults.frontEnd, dtiResults.backEnd);

            // --- Equity Summary (NEW) ---
            document.getElementById('finalEquity').textContent = formatCurrency(acceleratedResults.finalEquity);
            document.getElementById('finalPropertyValue').textContent = formatCurrency(acceleratedResults.finalPropertyValue);
            
            // --- Display Summary ---
            document.getElementById('totalMonthlyPaymentPITI').textContent = formatCurrency(totalMonthlyPITI);
            document.getElementById('standardPaymentDisplay').textContent = formatCurrency(standardPayment);
            
            // PMI Note
            if (pmiRate > 0 && initialLTV > 80 && acceleratedResults.pmiDropPeriod) {
                 document.getElementById('pmiDropNote').style.display = 'block';
                 document.getElementById('pmiDropPeriod').textContent = acceleratedResults.pmiDropPeriod;
            } else {
                 document.getElementById('pmiDropNote').style.display = 'none';
            }

            // The accelerated P&I payment displayed should be the sum of standard P&I + extra principal
            document.getElementById('acceleratedPaymentDisplay').textContent = formatCurrency(standardPayment + extraPayment); 
            
            // Nominal Interest
            document.getElementById('totalInterestOriginal').textContent = formatCurrency(originalResults.totalInterest);
            document.getElementById('totalInterestNew').textContent = formatCurrency(acceleratedResults.totalInterest);
            
            // NPV of Interest
            document.getElementById('npvOriginal').textContent = formatCurrency(originalResults.totalPVInterest);
            document.getElementById('npvNew').textContent = formatCurrency(acceleratedResults.totalPVInterest);

            const interestSaved = originalResults.totalInterest - acceleratedResults.totalInterest;
            const npvSaved = originalResults.totalPVInterest - acceleratedResults.totalPVInterest;

            // --- Render Chart (NEW LINE CHART) ---
            renderChart(acceleratedResults);

            const timeSavedPeriods = originalResults.payoffPeriod - acceleratedResults.payoffPeriod;
            const timeSavedYears = Math.floor(timeSavedPeriods / periodsPerYear);
            const timeSavedMonths = Math.round((timeSavedPeriods % periodsPerYear) * (12 / periodsPerYear));

            const calculatePayoffDate = (totalPeriods) => {
                let payoffDate = new Date(); 
                const totalMonths = Math.round(totalPeriods * (12 / periodsPerYear));
                payoffDate.setMonth(payoffDate.getMonth() + totalMonths);
                return payoffDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
            }

            document.getElementById('originalPayoffDate').textContent = calculatePayoffDate(originalResults.payoffPeriod);
            document.getElementById('newPayoffDate').textContent = calculatePayoffDate(acceleratedResults.payoffPeriod);
            document.getElementById('interestSaved').textContent = formatCurrency(interestSaved);
            document.getElementById('npvSaved').textContent = formatCurrency(npvSaved);
            document.getElementById('timeSaved').textContent = `${timeSavedYears} years and ${timeSavedMonths} months`;

            // --- Generate Amortization Table ---
            generateAmortizationTable(originalResults, acceleratedResults);

            // === 3. SHOCK TEST ===
            if (isShockTest) {
                const shockIncrease = parseFloat(document.getElementById('shockRateIncrease').value) / 100 || 0;
                const shockRate = annualRate + shockIncrease;
                
                const shockPayment = calculatePayment(principal, shockRate, periodsPerYear, totalPeriods);
                const paymentIncrease = shockPayment - standardPayment;
                
                document.getElementById('shock-results').style.display = 'block';
                document.getElementById('shockRateDisplay').textContent = (shockRate * 100).toFixed(2);
                document.getElementById('originalShockPaymentDisplay').textContent = formatCurrency(standardPayment);
                document.getElementById('shockPaymentDisplay').textContent = formatCurrency(shockPayment);
                document.getElementById('paymentIncrease').textContent = formatCurrency(paymentIncrease);
            }
        }


        // --- Table Generator (Updated for Equity) ---
        function generateAmortizationTable(originalResults, acceleratedResults) {
            const original = originalResults.schedule;
            const accelerated = acceleratedResults.schedule;
            
            const table = document.getElementById('amortizationTable');
            table.innerHTML = ''; 

            // Table Header
            const header = table.createTHead();
            
            let row1 = header.insertRow();
            row1.className = 'text-xs text-gray-700 bg-gray-50 uppercase tracking-wider';
            row1.innerHTML = `
                <th class="py-2 px-1 border-b-2 border-gray-300">#</th>
                <th colspan="4" class="py-2 px-1 border-b-2 border-gray-300 text-center bg-red-50/70 border-r border-red-200">Original Loan</th>
                <th colspan="10" class="py-2 px-1 border-b-2 border-gray-300 text-center bg-sky-50/70">Accelerated Payoff Scenario</th>
            `;
            
            let row2 = header.insertRow();
            row2.className = 'text-xs text-gray-600 bg-gray-100/70 font-medium';
            row2.innerHTML = `
                <th class="py-2 px-1 border-b border-gray-300 border-r border-gray-300">Period</th>
                <th class="py-2 px-1 border-b border-gray-300 text-right bg-red-50/70">Nom. Interest</th>
                <th class="py-2 px-1 border-b border-gray-300 text-right bg-red-50/70 text-npv">PV Interest</th>
                <th class="py-2 px-1 border-b border-gray-300 text-right bg-red-50/70">P&I Pmt</th>
                <th class="py-2 px-1 border-b border-gray-300 text-right bg-red-50/70 border-r border-red-200">Balance</th>
                
                <th class="py-2 px-1 border-b border-gray-300 text-right bg-sky-50/70 text-accent">Home Equity</th>
                <th class="py-2 px-1 border-b border-gray-300 text-right bg-sky-50/70 text-accent">Property Value</th>
                <th class="py-2 px-1 border-b border-gray-300 text-right bg-sky-50/70">P&I Pmt</th>
                <th class="py-2 px-1 border-b border-gray-300 text-right bg-sky-50/70">Tax/Ins/HOA</th>
                <th class="py-2 px-1 border-b border-gray-300 text-right bg-sky-50/70">Nom. Interest</th>
                <th class="py-2 px-1 border-b border-gray-300 text-right bg-sky-50/70 text-npv">PV Interest</th>
                <th class="py-2 px-1 border-b border-gray-300 text-right bg-sky-50/70">PMI</th>
                <th class="py-2 px-1 border-b border-gray-300 text-right bg-sky-50/70">Extra</th>
                <th class="py-2 px-1 border-b border-gray-300 text-right bg-sky-50/70">Total Pmt</th>
                <th class="py-2 px-1 border-b border-gray-300 text-right bg-sky-50/70">Balance</th>
            `;

            // Table Body
            const body = table.createTBody();
            const maxPeriods = Math.max(originalResults.payoffPeriod, acceleratedResults.payoffPeriod);

            for (let i = 0; i < maxPeriods; i++) {
                const originalData = original[i] || {};
                const newData = accelerated[i] || {};
                
                if (!originalData.balance && !newData.balance && i >= originalResults.payoffPeriod && i >= acceleratedResults.payoffPeriod) break;

                let row = body.insertRow();
                row.className = 'text-xs hover:bg-gray-50 border-b border-gray-200';
                
                const isOriginalFinished = !originalData.balance && i >= originalResults.payoffPeriod;
                const isNewFinished = !newData.balance && i >= acceleratedResults.payoffPeriod;
                
                // Calculate P&I Payment (Principal + Interest) for display in the accelerated column
                const newPNIPayment = (newData.pniPrincipal || 0) + (newData.interest || 0);
                const totalNewPayment = newPNIPayment + (newData.periodicPITI || 0) + (newData.extraPayment || 0);
                const taxInsHOA = (newData.periodicPITI || 0) - (newData.pmi || 0);

                row.innerHTML = `
                    <td class="p-2 border-r border-gray-300 font-semibold text-center">${i + 1}</td>
                    
                    <td class="p-2 text-right border-r border-red-200 ${isOriginalFinished ? 'text-gray-400 italic' : 'font-medium'} bg-red-50/50">
                        ${originalData.interest ? formatCurrency(originalData.interest) : '-'}
                    </td>
                    <td class="p-2 text-right border-r border-red-200 ${isOriginalFinished ? 'text-gray-400 italic' : 'font-medium text-npv'} bg-red-50/50">
                        ${originalData.pvInterest ? formatCurrency(originalData.pvInterest) : '-'}
                    </td>
                    <td class="p-2 text-right border-r border-red-200 ${isOriginalFinished ? 'text-gray-400 italic' : 'font-medium'} bg-red-50/50">
                        ${originalData.interest && originalData.principalPaid ? formatCurrency(originalData.interest + originalData.principalPaid) : '-'}
                    </td>
                    <td class="p-2 text-right border-r border-red-400 ${isOriginalFinished ? 'text-gray-400 italic' : 'font-bold'} bg-red-50/50">
                        ${originalData.balance ? formatCurrency(originalData.balance) : 'PAID OFF'}
                    </td>

                    <td class="p-2 text-right border-r border-sky-200 ${isNewFinished ? 'text-gray-400 italic' : 'font-bold text-accent'} bg-sky-50/50">
                        ${newData.totalEquity ? formatCurrency(newData.totalEquity) : 'FULL VALUE'}
                    </td>
                    <td class="p-2 text-right border-r border-sky-200 ${isNewFinished ? 'text-gray-400 italic' : 'font-medium text-accent'} bg-sky-50/50">
                        ${newData.propertyValue ? formatCurrency(newData.propertyValue) : 'FINAL VALUE'}
                    </td>
                    <td class="p-2 text-right border-r border-sky-200 ${isNewFinished ? 'text-gray-400 italic' : 'font-medium'} bg-sky-50/50">
                        ${newData.interest ? formatCurrency(newPNIPayment) : '-'}
                    </td>
                    <td class="p-2 text-right border-r border-sky-200 ${isNewFinished ? 'text-gray-400 italic' : 'font-medium'} bg-sky-50/50">
                        ${newData.interest ? formatCurrency(taxInsHOA) : '-'}
                    </td>
                    <td class="p-2 text-right border-r border-sky-200 ${isNewFinished ? 'text-gray-400 italic' : 'font-medium'} bg-sky-50/50">
                        ${newData.interest ? formatCurrency(newData.interest) : '-'}
                    </td>
                    <td class="p-2 text-right border-r border-sky-200 ${isNewFinished ? 'text-gray-400 italic' : 'font-medium text-npv'} bg-sky-50/50">
                        ${newData.pvInterest ? formatCurrency(newData.pvInterest) : '-'}
                    </td>
                    <td class="p-2 text-right border-r border-sky-200 ${isNewFinished ? 'text-gray-400 italic' : ''} bg-sky-50/50">
                        ${newData.pmi && newData.pmi > 0.01 ? formatCurrency(newData.pmi) : '-'}
                    </td>
                    <td class="p-2 text-right border-r border-sky-200 ${isNewFinished ? 'text-gray-400 italic' : ''} bg-sky-50/50">
                        ${newData.extraPayment && newData.extraPayment > 0.01 ? formatCurrency(newData.extraPayment) : '-'}
                    </td>
                    <td class="p-2 text-right border-r border-sky-200 ${isNewFinished ? 'text-gray-400 italic' : 'font-bold text-primary'} bg-sky-50/50">
                        ${newData.interest ? formatCurrency(totalNewPayment) : '-'}
                    </td>
                    <td class="p-2 text-right ${isNewFinished ? 'text-gray-400 italic' : 'font-bold'} bg-sky-50/50">
                        ${newData.balance ? formatCurrency(newData.balance) : 'PAID OFF'}
                    </td>
                `;
            }
        }
        
        // --- Clear Form Function (UPDATED) ---
        function clearForm() {
            // Set all numerical inputs to sensible defaults or 0
            document.getElementById('loanAmount').value = "300000";
            document.getElementById('interestRate').value = "6.5";
            document.getElementById('loanTerm').value = "30";
            document.getElementById('initialLTV').value = "90"; 
            document.getElementById('discountRate').value = "3.0";
            document.getElementById('appreciationRate').value = "3.5";
            
            // DTI Inputs
            document.getElementById('annualIncome').value = "120000";
            document.getElementById('nonMortgageDebt').value = "800";

            document.getElementById('propertyTax').value = "3600";
            document.getElementById('insurance').value = "1200";
            document.getElementById('hoa').value = "0";
            document.getElementById('pitiEscalationRate').value = "2.0"; 
            document.getElementById('pmiRate').value = "0.5"; 
            document.getElementById('extraPayment').value = "100";
            document.getElementById('lumpSumPayment').value = "5000";
            
            document.getElementById('lumpSumPeriod').value = "1"; 
            document.getElementById('refiPeriod').value = "60"; 
            document.getElementById('refiRate').value = "5.0"; 
            document.getElementById('refiTerm').value = "15"; 
            document.getElementById('refiClosingCosts').value = "5000"; 
            
            document.getElementById('shockRateIncrease').value = "1.0";
            
            document.getElementById('repaymentFrequency').value = "12";
            
            calculateMortgage();
        }

        // === Initial Load: Run calculation immediately with default values ===
        window.onload = function() {
            calculateMortgage();
        };
    </script>
</body>
</html>
